version: '3.8'

# Jaringan Bridge (Standar non-swarm)
networks:
  app_network:
    driver: bridge

volumes:
  drupal_db_data:
    driver: local
  drupal8_files_volume:
    driver: local
  drupal11_files_volume:
    driver: local
  drupal11_config_sync_volume:
    driver: local

services:
  # üåê Web Server Utama (Nginx)
  drupal_nginx:
    image: "nginx:1.29-alpine"
    container_name: drupal_web_server
    ports:
      - "8086:80"  # Akses Drupal 11
      - "8087:81"  # Akses Drupal 8
    volumes:
      - ./nginx-conf:/etc/nginx/conf.d:ro
      - ./drupal11-src:/var/www/html/drupal11:ro
      - ./drupal8-src:/var/www/html2/drupal8:ro
      - drupal11_files_volume:/var/www/html/drupal11/web/sites/default/files
      - drupal8_files_volume:/var/www/html2/drupal8/web/sites/default/files
    networks:
      - app_network
    depends_on:
      - drupal_fpm
      - drupal_fpm7
    restart: unless-stopped

  # ‚öôÔ∏è PHP-FPM Drupal 11 (PHP 8.4)
  drupal_fpm:
    image: 'drupal:11.2.2-php8.4-fpm-alpine3.21'
    container_name: d11_fpm
    environment:
      DRUPAL_DATABASE_HOST: 'drupal_db'
      DRUPAL_DATABASE_NAME: 'drupal11'
      DRUPAL_DATABASE_USER: 'drupaluser'
      DRUPAL_DATABASE_PASSWORD: 'your_drupal_db_password'
    volumes:
      - ./drupal11-src:/var/www/html/drupal11:rw
      - drupal11_files_volume:/var/www/html/drupal11/web/sites/default/files
      - drupal11_config_sync_volume:/var/www/html/drupal11/web/sync
      - ./drupal-data:/var/www/html/drupal11/web/sites/default
    networks:
      - app_network
    restart: unless-stopped

  # ‚öôÔ∏è PHP-FPM Drupal 8 (PHP 7.4)
  drupal_fpm7:
    image: 'drupal:8.9.20-php7.4-fpm-alpine3.13'
    container_name: d8_fpm
    working_dir: /var/www/html2/drupal8
    environment:
      DRUPAL_DATABASE_HOST: 'drupal_db'
      DRUPAL_DATABASE_NAME: 'drupal8'
      DRUPAL_DATABASE_USER: 'drupal8user'
      DRUPAL_DATABASE_PASSWORD: 'your_drupal_db_password'
    volumes:
      - ./drupal8-src:/var/www/html2/drupal8:rw
      - drupal8_files_volume:/var/www/html2/drupal8/web/sites/default/files
      - ./drupal-data:/var/www/html2/drupal8/web/sites/default
    networks:
      - app_network
    restart: unless-stopped

  # üóÉÔ∏è Database (MariaDB)
  drupal_db:
    image: 'mariadb:latest'
    container_name: drupal_database
    environment:
      MYSQL_ROOT_PASSWORD: 'your_drupal_db_password'
      MYSQL_DATABASE: 'drupaldb' # Database utama
      MYSQL_USER: 'drupaluser'
      MYSQL_PASSWORD: 'your_drupal_db_password'
    volumes:
      - drupal_db_data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - app_network
    restart: unless-stopped

  # üíæ Database Backup
  mysql-cron-backup:
    image: fradelg/mysql-cron-backup
    container_name: drupal_backup
    depends_on:
      - drupal_db
    volumes:
      - ./db-backup:/backup
    environment:
      - MYSQL_HOST=drupal_db
      - MYSQL_USER=root
      - MYSQL_PASS=your_drupal_db_password
      - MAX_BACKUPS=15
      - INIT_BACKUP=1
      - CRON_TIME=0 3 * * *
      - GZIP_LEVEL=9
      - MYSQLDUMP_OPTS=--no-tablespaces
    networks:
      - app_network
    restart: unless-stopped

  # üñ•Ô∏è phpMyAdmin
  phpmyadmin:
    image: linuxserver/phpmyadmin:5.2.2
    container_name: drupal_pma
    depends_on:
      - drupal_db
    environment:
      PMA_USER: root
      PMA_PASSWORD: your_drupal_db_password
      PMA_HOST: drupal_db
      TZ: Asia/Jakarta
    ports:
      - 8083:80
    networks:
      - app_network
    restart: unless-stopped